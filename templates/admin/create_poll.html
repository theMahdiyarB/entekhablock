{% extends "base.html" %}

{% block title %}ایجاد نظرسنجی جدید - مدیریت{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<!-- Persian Datepicker Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/lib/persian-datepicker.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/datepicker-theme.css') }}">
{% endblock %}

{% block content %}
<div class="admin-layout">
    <!-- Main Content -->
    <div class="admin-main fade-in-up">
        <header class="admin-header">
            <div>
                <a href="{{ url_for('admin_dashboard') }}"
                    style="text-decoration: none; color: var(--m3-primary); font-size: 14px; display: inline-block; margin-bottom: 16px;">←
                    بازگشت به داشبورد</a>
                <h1>ایجاد نظرسنجی جدید</h1>
                <p>تنظیمات و گزینه‌های نظرسنجی را در این بخش وارد کنید</p>
            </div>
        </header>

        <form action="{{ url_for('admin_create_poll') }}" method="POST" class="admin-card"
            style="margin: 0; max-width: 100%;" id="create-poll-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <section class="form-section">
                <h3 class="title-large" style="margin-bottom: 24px;">اطلاعات پایه</h3>
                <div class="form-group">
                    <div class="text-field-wrapper">
                        <div class="md-filled-text-field">
                            <input type="text" id="title" name="title" required placeholder=" " maxlength="100">
                            <label for="title">عنوان نظرسنجی</label>
                        </div>
                        <div class="field-supporting-text">
                            <span class="supporting-text">عنوان کوتاه و گویا</span>
                            <span class="character-counter">0/100</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="text-field-wrapper">
                        <div class="md-filled-text-field" style="height: auto;">
                            <textarea id="description" name="description" rows="4" placeholder=" " style="padding-top: 24px;" maxlength="500"></textarea>
                            <label for="description">توضیحات</label>
                        </div>
                        <div class="field-supporting-text">
                            <span class="supporting-text">جزئیات کامل نظرسنجی</span>
                            <span class="character-counter">0/500</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="form-section" style="margin-top: 48px;">
                <h3 class="title-large" style="margin-bottom: 24px;">زمان‌بندی (شمسی)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="form-group">
                        <div class="text-field-wrapper">
                            <div class="md-filled-text-field">
                                <input type="text" id="start_date_input" placeholder=" " required maxlength="10">
                                <label for="start_date_input">تاریخ شروع</label>
                            </div>
                            <div class="field-supporting-text">
                                <span class="supporting-text">YYYY/MM/DD</span>
                            </div>
                            <input type="hidden" id="start_date" name="start_date">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="text-field-wrapper">
                            <div class="md-filled-text-field">
                                <input type="text" id="end_date_input" placeholder=" " required maxlength="10">
                                <label for="end_date_input">تاریخ پایان</label>
                            </div>
                            <div class="field-supporting-text">
                                <span class="supporting-text">YYYY/MM/DD</span>
                            </div>
                            <input type="hidden" id="end_date" name="end_date">
                        </div>
                    </div>
                </div>
            </section>

            <section class="form-section" style="margin-top: 48px;">
                <h3 class="title-large" style="margin-bottom: 24px;">گزینه‌های رأی‌گیری</h3>
                <div id="options-container">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <div class="md-filled-text-field">
                            <input type="text" name="options[]" required placeholder=" ">
                            <label>گزینه ۱</label>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <div class="md-filled-text-field">
                            <input type="text" name="options[]" required placeholder=" ">
                            <label>گزینه ۲</label>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-outlined" id="add-option" style="margin-top: 8px;">
                    ➕ افزودن گزینه دیگر
                </button>
            </section>

            <section class="form-section"
                style="margin-top: 48px; padding-top: 32px; border-top: 1px solid var(--m3-outline-variant); display: flex; justify-content: flex-end; gap: 16px;">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-text">انصراف</a>
                <button type="submit" class="btn btn-filled">ایجاد و انتشار نظرسنجی</button>
            </section>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/lib/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lib/persian-date.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lib/persian-datepicker.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/datepicker-setup.js') }}"></script>
<script>
    $(document).ready(function() {
        // Initialize Datepickers
        setupPersianDatepicker('#start_date_input', '#start_date');
        setupPersianDatepicker('#end_date_input', '#end_date');

        // Add Option Logic
        document.getElementById('add-option').addEventListener('click', function () {
            const container = document.getElementById('options-container');
            const count = container.children.length + 1;

            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            formGroup.style.marginBottom = '12px';

            const filledField = document.createElement('div');
            filledField.className = 'md-filled-text-field';

            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'options[]';
            input.required = true;
            input.placeholder = ' '; // Required for label floating

            const label = document.createElement('label');
            label.innerText = `گزینه ${count}`;

            filledField.appendChild(input);
            filledField.appendChild(label);
            formGroup.appendChild(filledField);

            container.appendChild(formGroup);
        });

        // Manual validation for hidden inputs
        $('#create-poll-form').on('submit', function(e) {
            const startVal = $('#start_date').val();
            const endVal = $('#end_date').val();

            if (!startVal) {
                // Try sync from visible
                const visible = $('#start_date_input').val();
                if(visible && visible.length === 10) $('#start_date').val(visible.replace(/\//g, '-'));
                else { e.preventDefault(); alert('لطفاً تاریخ شروع را وارد کنید'); return; }
            }
            if (!endVal) {
                 // Try sync from visible
                const visible = $('#end_date_input').val();
                if(visible && visible.length === 10) $('#end_date').val(visible.replace(/\//g, '-'));
                else { e.preventDefault(); alert('لطفاً تاریخ پایان را وارد کنید'); return; }
            }
        });
    });
</script>
{% endblock %}
